# -*- makefile -*-

src-dot := $(wildcard *.dot)
src-png := $(subst .dot,.png,$(src-dot))
png     := $(addprefix images/,$(src-png))

DIRS	+= images
DIRS	+= _build

gz-png += images/branches.png
src := $(shell find . \( -name '*.dot' -o -name '*.m4' \) -print)
#  $(foreach val,$(src),$(info src: $(val)))


##----------------##
##---]  MAIN  [---##
##----------------##
all: $(gz-png)

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
images/%.png: _build/%.dot
	mkdir -p images
	dot -Tpng $< > $@
	-eog $@ >/dev/null 2>/dev/null &

# $(gz-png) : $(src)
images/%.png: $(src)

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
_build/%.dot: %.m4
	mkdir -p _build
	m4 $< > $@

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
view-png = $(wildcard images/*.png)
view:
	eog $(view-png)

lint:
	m4 branches.m4

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
init:
	mkdir -p $(DIRS)

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
clean:
	$(RM) -r $(DIRS)
	$(MAKE) init

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
edit:
	~/etc/emacs $$(find . -name '*.m4' -print) branches.m4

## ----------------------------------------------------------------------- 
## ----------------------------------------------------------------------- 
help:
	@echo
	@echo "USAGE: $(MAKE)"
	@echo "  view    View rendered probe images."
	@echo "  init    mkdir"
	@echo "  clean   Remove generated targets."

# [EOF]
